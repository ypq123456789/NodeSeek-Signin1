# 🚀 CloudFlare 自动重试 - 快速参考

## 📌 功能概述

当签到或登录遇到 CloudFlare 阻拦(403错误)时,系统会自动:
1. 检测 CloudFlare 挑战页特征
2. 切换浏览器指纹
3. 等待60秒后重试
4. 轮流尝试14个不同的 Chrome 版本

## 🎯 支持的指纹版本

```
chrome99   chrome100  chrome101  chrome104  chrome107
chrome110  chrome116  chrome119  chrome120  chrome123
chrome124  chrome131  chrome133a chrome136
```

## ⏱️ 重要参数

- **重试间隔**: 60秒 (1分钟)
- **指纹数量**: 14个
- **最大耗时**: 约14分钟 (如果所有指纹都需要尝试)

## 🔧 配置方法

### 使用默认配置
无需任何配置,开箱即用!

### 自定义首选指纹
设置环境变量:
```bash
NS_IMPERSONATE=chrome120
```

## 📊 使用场景

### 场景1: 签到被阻拦
```
签到失败: 403 Cloudflare challenge
↓
自动切换指纹重试
↓
成功签到!
```

### 场景2: 登录被阻拦
```
登录失败: CloudFlare 检测
↓
自动切换指纹重试
↓
登录成功,获取新 Cookie!
```

### 场景3: 查询统计被阻拦
```
统计查询失败: 403 错误
↓
自动切换指纹重试
↓
成功获取数据!
```

## 📝 日志示例

### 成功日志
```
[INFO] 检测到CloudFlare阻拦,开始轮流尝试不同指纹...
[INFO] 等待60秒后使用指纹 chrome100 重试...
[SUCCESS] 使用指纹 chrome100 成功绕过CloudFlare!
签到成功: 获得3个鸡腿
```

### 失败日志
```
[WARN] 指纹 chrome99 仍被CloudFlare阻拦,继续尝试下一个...
[WARN] 指纹 chrome100 仍被CloudFlare阻拦,继续尝试下一个...
...
[FAIL] 所有指纹尝试完毕,仍被CloudFlare阻拦
```

## ✅ 支持的环境

- ✅ Docker 容器
- ✅ 青龙面板
- ✅ GitHub Actions
- ✅ 本地运行
- ✅ 其他环境

## 🎯 最佳实践

1. **首次运行**: 让系统自动选择最佳指纹
2. **多次失败**: 可以手动设置 `NS_IMPERSONATE` 环境变量
3. **长期使用**: 定期观察日志,了解哪个指纹最稳定
4. **性能优化**: 如果某个指纹经常成功,可以将其设为默认

## 🔍 故障排查

### 问题: 所有指纹都失败
**解决方案**:
1. 检查网络连接
2. 确认目标网站是否正常
3. 等待一段时间后重试
4. 检查 IP 是否被封禁

### 问题: 重试时间过长
**解决方案**:
1. 这是正常现象(每次重试等待60秒)
2. 可以观察日志,了解哪个指纹最快成功
3. 设置该指纹为 `NS_IMPERSONATE` 环境变量

### 问题: 某些指纹经常失败
**解决方案**:
1. 这是正常现象,不同指纹在不同环境下表现不同
2. 系统会自动尝试所有指纹
3. 无需人工干预

## 📞 技术支持

如果遇到问题,请查看:
1. `IMPLEMENTATION_SUMMARY.md` - 实现总结
2. `CLOUDFLARE_RETRY_UPDATE.md` - 更新说明
3. 运行 `python test_cloudflare_retry.py` 进行测试

## 🎉 更新历史

- **2026-02-13**: 实现 CloudFlare 自动重试功能
  - 添加14个 Chrome 指纹支持
  - 实现60秒重试间隔
  - 智能检测 CloudFlare 挑战页
  - 支持签到、登录、查询等所有场景

---
**提示**: 此功能完全自动化,无需人工干预! 🚀
